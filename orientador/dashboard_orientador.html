<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Orientação | SME FMM</title>
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Infraestrutura SME FMM -->
    <script src="../assets/js/supabase_client.js"></script>
    <script src="../sidebar.js"></script>
    <script src="../assets/js/constants.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fmm: {
                            dark: '#003c5b',
                            blue: '#00638f',
                            green: '#80a51b',
                            lime: '#c8d400',
                            bg: '#f8fafc'
                        },
                        clinical: {
                            pending: '#f59e0b', 
                            ongoing: '#3b82f6', 
                            critical: '#ef4444' 
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .kpi-card {
            background: white; border: 1px solid rgba(0, 60, 91, 0.05); border-radius: 28px;
            padding: 24px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 60, 91, 0.12); }

        .chart-container {
            background: white; border-radius: 32px; border: 1px solid #f1f5f9; padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }

        .alert-card {
            border-left: 4px solid; animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { border-left-color: rgba(245, 158, 11, 1); }
            50% { border-left-color: rgba(245, 158, 11, 0.3); }
            100% { border-left-color: rgba(245, 158, 11, 1); }
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-ui { animation: fadeInUp 0.4s ease-out forwards; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <!-- SIDEBAR CONTAINER -->
    <aside id="sidebar-container" class="w-72 bg-fmm-dark text-white flex-shrink-0 flex flex-col shadow-2xl relative z-40 transition-all duration-300"></aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 overflow-hidden">
        
        <!-- HEADER -->
        <header class="bg-white h-20 border-b flex items-center justify-between px-10 z-10 shadow-sm flex-shrink-0">
            <div class="flex flex-col">
                <h1 class="text-xl font-black text-fmm-dark tracking-tight uppercase flex items-center gap-2">
                    <span class="w-2 h-5 bg-fmm-green rounded-full"></span>
                    Painel de Orientação
                </h1>
                <p class="text-[10px] text-fmm-blue font-bold uppercase tracking-widest" id="current-date">Sincronizando...</p>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex flex-col items-end">
                    <span id="userName" class="text-xs font-black text-fmm-dark uppercase">Carregando...</span>
                    <span class="text-[9px] text-fmm-blue font-black uppercase opacity-60">Serviço de Psicologia/Orientação</span>
                </div>
                <div id="userInitials" class="w-11 h-11 rounded-xl bg-fmm-blue text-white flex items-center justify-center font-black shadow-lg border-2 border-white uppercase">?</div>
            </div>
        </header>

        <!-- CONTEÚDO SCROLLABLE -->
        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar space-y-8 bg-slate-50">
            
            <!-- SEÇÃO 1: INDICADORES (KPIs REAIS) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 flex-shrink-0">
                <div class="kpi-card animate-ui">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-fmm-blue/10 rounded-2xl flex items-center justify-center text-fmm-blue">
                            <i data-lucide="users" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">Histórico</span>
                    </div>
                    <p class="text-3xl font-black text-fmm-dark" id="kpi-alunos">0</p>
                    <h3 class="text-[10px] font-black text-fmm-blue uppercase tracking-widest mt-1">Alunos Atendidos</h3>
                </div>

                <div class="kpi-card animate-ui" style="animation-delay: 0.1s">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-fmm-green/10 rounded-2xl flex items-center justify-center text-fmm-green">
                            <i data-lucide="activity" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-green-600 uppercase tracking-tighter">Volume</span>
                    </div>
                    <p class="text-3xl font-black text-fmm-dark" id="kpi-atendimentos">0</p>
                    <h3 class="text-[10px] font-black text-fmm-blue uppercase tracking-widest mt-1">Total de Sessões</h3>
                </div>

                <div class="kpi-card animate-ui" style="animation-delay: 0.2s">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-600">
                            <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-amber-600 uppercase tracking-tighter">Triagem</span>
                    </div>
                    <p class="text-3xl font-black text-fmm-dark" id="kpi-chamados">0</p>
                    <h3 class="text-[10px] font-black text-fmm-blue uppercase tracking-widest mt-1">Chamados Pendentes</h3>
                </div>

                <div class="kpi-card animate-ui" style="animation-delay: 0.3s">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-red-50 rounded-2xl flex items-center justify-center text-red-500">
                            <i data-lucide="alert-circle" class="w-6 h-6"></i>
                        </div>
                        <span class="text-[10px] font-black text-red-500 uppercase tracking-tighter">Fila</span>
                    </div>
                    <p class="text-3xl font-black text-fmm-dark" id="kpi-em-curso">0</p>
                    <h3 class="text-[10px] font-black text-fmm-blue uppercase tracking-widest mt-1">Em Acompanhamento</h3>
                </div>
            </div>

            <!-- SEÇÃO 2: GRÁFICOS E ALERTAS -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                
                <!-- Coluna Principal: Gráficos -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="chart-container animate-ui" style="animation-delay: 0.4s">
                        <div class="flex justify-between items-center mb-8">
                            <h3 class="text-sm font-black text-fmm-dark uppercase tracking-widest flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4 text-fmm-blue"></i>
                                Evolução de Atendimentos
                            </h3>
                        </div>
                        <canvas id="evolutionChart" height="120"></canvas>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="chart-container animate-ui" style="animation-delay: 0.5s">
                            <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-6">Natureza da Demanda</h3>
                            <canvas id="typeChart" height="200"></canvas>
                        </div>
                        <div class="chart-container animate-ui" style="animation-delay: 0.5s">
                            <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-6">Status dos Chamados</h3>
                            <div class="space-y-4 py-4" id="status-distribution">
                                <!-- Preenchido via JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coluna Lateral: Demandas Recentes e Alertas -->
                <div class="space-y-8 animate-ui" style="animation-delay: 0.6s">
                    <!-- ALERTA DINÂMICO -->
                    <div id="alert-container" class="hidden">
                        <div class="alert-card bg-white p-6 rounded-3xl border border-slate-100 shadow-xl shadow-amber-500/5">
                            <div class="flex items-center gap-3 text-amber-600 mb-4">
                                <i data-lucide="bell-ring" class="w-5 h-5"></i>
                                <h4 class="text-xs font-black uppercase tracking-widest">Atenção Necessária</h4>
                            </div>
                            <p class="text-sm text-slate-600 font-medium leading-relaxed mb-4">
                                Existem <span class="font-bold text-fmm-dark" id="alert-pending-count">0 demandas</span> que aguardam triagem inicial.
                            </p>
                            <button onclick="location.href='chamados_orientador.html'" class="w-full py-3 bg-fmm-dark text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-fmm-blue transition-all">
                                Realizar Triagem
                            </button>
                        </div>
                    </div>

                    <!-- LISTA REAL DE CHAMADOS RECENTES -->
                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col h-full">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                            <h4 class="text-xs font-black text-fmm-dark uppercase tracking-widest">Chamados Recentes</h4>
                            <a href="chamados_orientador.html" class="text-[9px] font-black text-fmm-blue hover:underline uppercase">Ver todos</a>
                        </div>
                        <div class="divide-y divide-slate-50" id="recent-referrals">
                            <div class="p-10 text-center text-slate-300 italic text-xs">
                                <i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto mb-2"></i>
                                Sincronizando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;
        let evolutionChart = null;
        let typeChart = null;

        async function init() {
            if (window.SidebarComponent) await SidebarComponent.render('sidebar-container');
            
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            if (!user) return window.location.href = '../index.html';

            const { data: profile } = await window.supabaseClient.from('perfis').select('*').eq('id', user.id).single();
            if (profile) {
                document.getElementById('userName').innerText = profile.nome_completo;
                document.getElementById('userInitials').innerText = profile.nome_completo.charAt(0);
            }

            if (window.ManausTime) {
                document.getElementById('current-date').innerText = ManausTime.formatFull(new Date());
            }

            await fetchData();
            lucide.createIcons();
        }

        async function fetchData() {
            try {
                // 1. KPIs de Chamados
                const { data: chamados } = await window.supabaseClient.from('orientacao_chamados').select('status, data_abertura, alunos(nome_completo, ra, id_turma, turmas(nome))');
                
                const pending = chamados.filter(c => c.status === 'pending');
                const ongoing = chamados.filter(c => c.status === 'ongoing');
                const finished = chamados.filter(c => c.status === 'finished');

                document.getElementById('kpi-chamados').innerText = pending.length.toString().padStart(2, '0');
                document.getElementById('kpi-em-curso').innerText = ongoing.length.toString().padStart(2, '0');

                if (pending.length > 0) {
                    document.getElementById('alert-container').classList.remove('hidden');
                    document.getElementById('alert-pending-count').innerText = `${pending.length} ${pending.length === 1 ? 'demanda' : 'demandas'}`;
                }

                // 2. Atendimentos e Alunos Únicos
                const { data: atendimentos } = await window.supabaseClient.from('orientacao_atendimentos').select('ra_aluno, classificacao, data_atendimento');
                
                const uniqueStudents = new Set(atendimentos.map(a => a.ra_aluno));
                document.getElementById('kpi-alunos').innerText = uniqueStudents.size;
                document.getElementById('kpi-atendimentos').innerText = atendimentos.length;

                // 3. Renderizar Gráficos e Listas
                renderStatusDistribution(pending.length, ongoing.length, finished.length);
                renderRecentCalls(chamados);
                renderChartsData(atendimentos);

            } catch (err) {
                console.error("Erro no Dashboard:", err);
            }
        }

        function renderStatusDistribution(pending, ongoing, finished) {
            const container = document.getElementById('status-distribution');
            const total = pending + ongoing + finished || 1;
            const stats = [
                { label: 'Aguardando Triagem', count: pending, color: 'bg-amber-500' },
                { label: 'Em Atendimento', count: ongoing, color: 'bg-blue-500' },
                { label: 'Concluído', count: finished, color: 'bg-green-500' }
            ];

            container.innerHTML = stats.map(s => `
                <div class="space-y-1.5">
                    <div class="flex justify-between items-center text-[10px] font-bold uppercase tracking-widest text-slate-500">
                        <span>${s.label}</span>
                        <span>${s.count}</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full ${s.color} transition-all duration-1000" style="width: ${(s.count/total)*100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentCalls(chamados) {
            const container = document.getElementById('recent-referrals');
            const recent = [...chamados]
                .sort((a, b) => new Date(b.data_abertura) - new Date(a.data_abertura))
                .slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = `<div class="p-10 text-center text-slate-300 italic text-xs">Nenhum chamado aberto.</div>`;
                return;
            }

            container.innerHTML = recent.map(c => {
                const statusLabels = { 'pending': 'Pendente', 'ongoing': 'Em Curso', 'finished': 'Concluído', 'ignored': 'Arquivado' };
                const statusColors = { 'pending': 'text-amber-600 bg-amber-50', 'ongoing': 'text-blue-600 bg-blue-50', 'finished': 'text-green-600 bg-green-50', 'ignored': 'text-slate-400 bg-slate-50' };
                const date = ManausTime.format(c.data_abertura).substring(0, 5);

                return `
                    <div class="p-4 hover:bg-slate-50 transition-colors flex items-center justify-between group">
                        <div class="flex flex-col gap-0.5">
                            <h5 class="text-xs font-bold text-fmm-dark uppercase truncate max-w-[150px]">${c.alunos.nome_completo}</h5>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-400 font-bold">${c.alunos.turmas?.nome || 'FMM'}</span>
                                <span class="w-1 h-1 rounded-full bg-slate-200"></span>
                                <span class="text-[9px] text-slate-400 font-bold">${date}</span>
                            </div>
                        </div>
                        <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase tracking-tighter ${statusColors[c.status]}">
                            ${statusLabels[c.status]}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function renderChartsData(atendimentos) {
            // 1. Processar Evolução (Últimos 6 meses)
            const months = [];
            const counts = [];
            const now = new Date();
            for(let i=5; i>=0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push(d.toLocaleString('pt-BR', { month: 'short' }));
                const monthKey = d.toISOString().substring(0, 7);
                counts.push(atendimentos.filter(a => a.data_atendimento.startsWith(monthKey)).length);
            }

            if(evolutionChart) evolutionChart.destroy();
            const evolutionCtx = document.getElementById('evolutionChart').getContext('2d');
            evolutionChart = new Chart(evolutionCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: counts,
                        borderColor: '#00638f',
                        backgroundColor: 'rgba(0, 99, 143, 0.05)',
                        fill: true, tension: 0.4, borderWidth: 4, pointRadius: 4, pointBackgroundColor: '#00638f'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } }
                }
            });

            // 2. Processar Natureza (Classificação)
            const natureCounts = { 'Cognitivo': 0, 'Emocional': 0, 'Social': 0, 'Familiar': 0, 'Físico': 0, 'Outros': 0 };
            atendimentos.forEach(a => {
                if(a.classificacao && Array.isArray(a.classificacao)) {
                    a.classificacao.forEach(tag => { if(natureCounts[tag] !== undefined) natureCounts[tag]++; });
                }
            });

            if(typeChart) typeChart.destroy();
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(natureCounts),
                    datasets: [{
                        data: Object.values(natureCounts),
                        backgroundColor: ['#003c5b', '#00638f', '#80a51b', '#c8d400', '#f59e0b', '#94a3b8'],
                        borderWidth: 0, hoverOffset: 10
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true, font: { size: 9, weight: 'bold' } } }
                    }
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>